embed-server --server-config=${server.config:standalone-full.xml}

if (outcome != success) of /extension=org.keycloak.keycloak-adapter-subsystem:read-resource
    /extension=org.keycloak.keycloak-adapter-subsystem/:add(module=org.keycloak.keycloak-adapter-subsystem)
else
    echo Keycloak OpenID Connect Extension already installed
end-if

if (outcome != success) of /subsystem=keycloak:read-resource
    /subsystem=keycloak:add
else
    echo Keycloak OpenID Connect Subsystem already installed
end-if

if (outcome != success) of /subsystem=elytron/custom-realm=KeycloakOIDCRealm:read-resource
    /subsystem=elytron/custom-realm=KeycloakOIDCRealm:add(class-name=org.keycloak.adapters.elytron.KeycloakSecurityRealm, module=org.keycloak.keycloak-wildfly-elytron-oidc-adapter)
else
    echo Keycloak OpenID Connect Realm already installed
end-if

if (outcome != success) of /subsystem=elytron/security-domain=KeycloakDomain:read-resource
    /subsystem=elytron/security-domain=KeycloakDomain:add(default-realm=KeycloakOIDCRealm,permission-mapper=default-permission-mapper,security-event-listener=local-audit,realms=[{realm=KeycloakOIDCRealm}])
else
    echo Keycloak Security Domain already installed. Trying to install Keycloak OpenID Connect Realm.
    /subsystem=elytron/security-domain=KeycloakDomain:list-add(name=realms, value={realm=KeycloakOIDCRealm})
end-if

if (outcome != success) of /subsystem=elytron/constant-realm-mapper=keycloak-oidc-realm-mapper:read-resource
    /subsystem=elytron/constant-realm-mapper=keycloak-oidc-realm-mapper:add(realm-name=KeycloakOIDCRealm)
else
    echo Keycloak OpenID Connect Realm Mapper already installed
end-if

if (outcome != success) of /subsystem=elytron/service-loader-http-server-mechanism-factory=keycloak-oidc-http-server-mechanism-factory:read-resource
    /subsystem=elytron/service-loader-http-server-mechanism-factory=keycloak-oidc-http-server-mechanism-factory:add(module=org.keycloak.keycloak-wildfly-elytron-oidc-adapter)
else
    echo Keycloak OpenID Connect HTTP Mechanism already installed
end-if

if (outcome != success) of /subsystem=elytron/aggregate-http-server-mechanism-factory=keycloak-http-server-mechanism-factory:read-resource
    /subsystem=elytron/aggregate-http-server-mechanism-factory=keycloak-http-server-mechanism-factory:add(http-server-mechanism-factories=[keycloak-oidc-http-server-mechanism-factory, global])
else
    echo Keycloak HTTP Mechanism Factory already installed. Trying to install Keycloak OpenID Connect HTTP Mechanism Factory.
    /subsystem=elytron/aggregate-http-server-mechanism-factory=keycloak-http-server-mechanism-factory:list-add(name=http-server-mechanism-factories, value=keycloak-oidc-http-server-mechanism-factory)
end-if


if (outcome != success) of /subsystem=elytron/http-authentication-factory=keycloak-http-authentication:read-resource
    /subsystem=elytron/http-authentication-factory=keycloak-http-authentication:add(security-domain=KeycloakDomain,http-server-mechanism-factory=keycloak-http-server-mechanism-factory,mechanism-configurations=[{mechanism-name=KEYCLOAK,mechanism-realm-configurations=[{realm-name=KeycloakOIDCRealm,realm-mapper=keycloak-oidc-realm-mapper}]}])
else
    echo Keycloak HTTP Authentication Factory already installed. Trying to install Keycloak OpenID Connect Mechanism Configuration
    /subsystem=elytron/http-authentication-factory=keycloak-http-authentication:list-add(name=mechanism-configurations, value={mechanism-name=KEYCLOAK,mechanism-realm-configurations=[{realm-name=KeycloakOIDCRealm,realm-mapper=keycloak-oidc-realm-mapper}]})
end-if

if (outcome != success) of /subsystem=undertow/application-security-domain=other:read-resource
    /subsystem=undertow/application-security-domain=other:add(http-authentication-factory=keycloak-http-authentication)
else
    echo Undertow already configured with Keycloak
end-if


/subsystem=keycloak/secure-deployment=kie-server.war/:add(ssl-required=external)
/subsystem=keycloak/secure-deployment=kie-server.war/:write-attribute(name=realm,value=sales-analyzer)
/subsystem=keycloak/secure-deployment=kie-server.war/:write-attribute(name=auth-server-url,value=http://kc:8080/auth)
/subsystem=keycloak/secure-deployment=kie-server.war/:write-attribute(name=resource,value=kie-server)
/subsystem=keycloak/secure-deployment=kie-server.war/:write-attribute(name=principal-attribute,value=preferred_username)
/subsystem=keycloak/secure-deployment=kie-server.war/:write-attribute(name=enable-basic-auth,value=true)
/subsystem=keycloak/secure-deployment=kie-server.war/:write-attribute(name=realm-public-key,value=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhRI9Og4T0OHCXq1hvGjyi0dPsKHeW62tMCm9orKTnn+nUONqcxLkKCcD7HXK0CGVOWy7abJ/c+LypSP9+Zx8pWDzX9K3uULubMBe00JQqtrutlLILFgsek2Ao4Ch3hmxBU7+0alYrZdL8VEul8vb7So9OQVa6KbJTBx1hDAnDMmekxo8Qvxsl6q9V/HOta/ZGl1ZaIkqnlHFVPDR83WrOOsVyHs5thonXR1ii5JDSGB4iEmYnDtkNXhtule5W8nHjUTlD/mctl3zP4TGiMVObh3xdm0UvJHc4dIrD+jgTKUFAMl2oOnPRx4F9mWHRDa63fx96BXBXWWdPw9XpxaHkwIDAQAB)
/subsystem=keycloak/secure-deployment=kie-server.war/credential=secret/:add(value=f435bf4e-e27c-4101-ad0c-3671a6a119f4)

/subsystem=keycloak/secure-deployment=sa-admin.war/:add(ssl-required=external)
/subsystem=keycloak/secure-deployment=sa-admin.war/:write-attribute(name=realm,value=sales-analyzer)
/subsystem=keycloak/secure-deployment=sa-admin.war/:write-attribute(name=auth-server-url,value=http://kc:8080/auth/)
/subsystem=keycloak/secure-deployment=sa-admin.war/:write-attribute(name=resource,value=sa-admin-client-rest)
/subsystem=keycloak/secure-deployment=sa-admin.war/:write-attribute(name=principal-attribute,value=preferred_username)
/subsystem=keycloak/secure-deployment=sa-admin.war/:write-attribute(name=enable-basic-auth,value=true)
/subsystem=keycloak/secure-deployment=sa-admin.war/:write-attribute(name=realm-public-key,value=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhRI9Og4T0OHCXq1hvGjyi0dPsKHeW62tMCm9orKTnn+nUONqcxLkKCcD7HXK0CGVOWy7abJ/c+LypSP9+Zx8pWDzX9K3uULubMBe00JQqtrutlLILFgsek2Ao4Ch3hmxBU7+0alYrZdL8VEul8vb7So9OQVa6KbJTBx1hDAnDMmekxo8Qvxsl6q9V/HOta/ZGl1ZaIkqnlHFVPDR83WrOOsVyHs5thonXR1ii5JDSGB4iEmYnDtkNXhtule5W8nHjUTlD/mctl3zP4TGiMVObh3xdm0UvJHc4dIrD+jgTKUFAMl2oOnPRx4F9mWHRDa63fx96BXBXWWdPw9XpxaHkwIDAQAB)
/subsystem=keycloak/secure-deployment=sa-admin.war/credential=secret/:add(value=1dd5565e-0f65-43be-8076-6220fd2f1d4f)


/subsystem=keycloak/secure-deployment=sa-case-manager.war/:add(ssl-required=external)
/subsystem=keycloak/secure-deployment=sa-case-manager.war/:write-attribute(name=realm,value=sales-analyzer)
/subsystem=keycloak/secure-deployment=sa-case-manager.war/:write-attribute(name=auth-server-url,value=http://kc:8080/auth/)
/subsystem=keycloak/secure-deployment=sa-case-manager.war/:write-attribute(name=resource,value=sa-admin-client)
/subsystem=keycloak/secure-deployment=sa-case-manager.war/:write-attribute(name=principal-attribute,value=preferred_username)
/subsystem=keycloak/secure-deployment=sa-case-manager.war/:write-attribute(name=enable-basic-auth,value=true)
/subsystem=keycloak/secure-deployment=sa-case-manager.war/:write-attribute(name=realm-public-key,value=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhRI9Og4T0OHCXq1hvGjyi0dPsKHeW62tMCm9orKTnn+nUONqcxLkKCcD7HXK0CGVOWy7abJ/c+LypSP9+Zx8pWDzX9K3uULubMBe00JQqtrutlLILFgsek2Ao4Ch3hmxBU7+0alYrZdL8VEul8vb7So9OQVa6KbJTBx1hDAnDMmekxo8Qvxsl6q9V/HOta/ZGl1ZaIkqnlHFVPDR83WrOOsVyHs5thonXR1ii5JDSGB4iEmYnDtkNXhtule5W8nHjUTlD/mctl3zP4TGiMVObh3xdm0UvJHc4dIrD+jgTKUFAMl2oOnPRx4F9mWHRDa63fx96BXBXWWdPw9XpxaHkwIDAQAB)
/subsystem=keycloak/secure-deployment=sa-case-manager.war/credential=secret/:add(value=1dd5565e-0f65-43be-8076-6220fd2f1d4f)


/subsystem=keycloak/secure-deployment=sa-etl-controller.war/:add(ssl-required=external)
/subsystem=keycloak/secure-deployment=sa-etl-controller.war/:write-attribute(name=realm,value=sales-analyzer)
/subsystem=keycloak/secure-deployment=sa-etl-controller.war/:write-attribute(name=auth-server-url,value=http://kc:8080/auth/)
/subsystem=keycloak/secure-deployment=sa-etl-controller.war/:write-attribute(name=resource,value=sa-admin-client)
/subsystem=keycloak/secure-deployment=sa-etl-controller.war/:write-attribute(name=principal-attribute,value=preferred_username)
/subsystem=keycloak/secure-deployment=sa-etl-controller.war/:write-attribute(name=enable-basic-auth,value=true)
/subsystem=keycloak/secure-deployment=sa-etl-controller.war/:write-attribute(name=realm-public-key,value=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhRI9Og4T0OHCXq1hvGjyi0dPsKHeW62tMCm9orKTnn+nUONqcxLkKCcD7HXK0CGVOWy7abJ/c+LypSP9+Zx8pWDzX9K3uULubMBe00JQqtrutlLILFgsek2Ao4Ch3hmxBU7+0alYrZdL8VEul8vb7So9OQVa6KbJTBx1hDAnDMmekxo8Qvxsl6q9V/HOta/ZGl1ZaIkqnlHFVPDR83WrOOsVyHs5thonXR1ii5JDSGB4iEmYnDtkNXhtule5W8nHjUTlD/mctl3zP4TGiMVObh3xdm0UvJHc4dIrD+jgTKUFAMl2oOnPRx4F9mWHRDa63fx96BXBXWWdPw9XpxaHkwIDAQAB)
/subsystem=keycloak/secure-deployment=sa-etl-controller.war/credential=secret/:add(value=1dd5565e-0f65-43be-8076-6220fd2f1d4f)


/subsystem=infinispan/cache-container=sa-container/:add
/subsystem=infinispan/cache-container=sa-container/local-cache=userPreferences:add(indexing=NONE)
/subsystem=infinispan/cache-container=sa-container/local-cache=userPreferences/transaction=TRANSACTION:add(locking=PESSIMISTIC, mode=FULL_XA)
/subsystem=infinispan/cache-container=sa-container/local-cache=userPreferences/eviction=EVICTION:add(strategy=NONE)
/subsystem=infinispan/cache-container=sa-container/local-cache=userPreferences/locking=LOCKING:add(acquire-timeout=30000,isolation=REPEATABLE_READ)


/subsystem=datasources/jdbc-driver=postgresql-jdbc4:add(driver-name="postgresql-jdbc4",driver-module-name="org.postgresql")
/subsystem=datasources/data-source=saDS_pool:add(jndi-name=java:jboss/jdbc/SalesAnalyzerDS, connection-url=jdbc:postgresql://sa-pg:5432/postgres ,driver-name=postgresql-jdbc4,driver-class=org.postgresql.Driver ,jta=true , enabled=true, use-java-context=true, use-ccm=true)
/subsystem=datasources/data-source=saDS_pool:write-attribute(name=min-pool-size,value=2)
/subsystem=datasources/data-source=saDS_pool:write-attribute(name=max-pool-size,value=20)
/subsystem=datasources/data-source=saDS_pool:write-attribute(name=check-valid-connection-sql,value="SELECT 1")
/subsystem=datasources/data-source=saDS_pool:write-attribute(name=validate-on-match,value=false)
/subsystem=datasources/data-source=saDS_pool:write-attribute(name=background-validation,value=false)
/subsystem=datasources/data-source=saDS_pool:write-attribute(name=use-fast-fail,value=false)
/subsystem=datasources/data-source=saDS_pool:write-attribute(name=user-name,value=postgres)
/subsystem=datasources/data-source=saDS_pool:write-attribute(name=password,value=postgres)


/system-property=aes_key:add(value="qvDHwQChO/NVvxCYG3yO+w==")
/system-property=org.drools.server.filter.classes:add(value=true)
/system-property=org.kie.server.persistence.schema:add(value=KIESERVER)
/system-property=org.kie.server.sync.deploy:add(value=false)
/system-property=org.kie.server.persistence.dialect:add(value="org.hibernate.dialect.PostgreSQLDialect")
/system-property=org.kie.server.persistence.ds:add(value="java:jboss/jdbc/SalesAnalyzerDS")
/system-property=TALEND_JOB_ROOT:add(value="/opt/jboss/jobs")
/system-property=FILE_IMPORT_DIRECTORY:add(value="/opt/jboss/jobs")
/system-property=keycloak_url:add(value="http://kc:8080/auth")
/system-property=keycloak_admin_realm:add(value="master")
/system-property=keycloak_admin_clientid:add(value="realm-management")
/system-property=client_secret:add(value="0db78c54-d83d-4f11-941a-e945e9631ecc")
/system-property=keycloak_admin_user:add(value="admin")
/system-property=keycloak_admin_password:add(value="qwerty")
/system-property=keycloak_managed_realm:add(value="sales-analyzer")
/system-property=kie_server_url:add(value="http://wf:8081/kie-server/services/rest/server")
/system-property=tura.request.file.storage:add(value=true)
/system-property=org.jbpm.ht.callback:add(value="custom")
/system-property=org.jbpm.ht.custom.callback:add(value="org.kie.server.services.impl.security.ElytronUserGroupCallback")
